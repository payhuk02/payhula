# üî• GUIDE COMPLET - SENTRY ERROR TRACKING

**Date :** 27 octobre 2025  
**Version Sentry :** @sentry/react 8.x  
**Dur√©e setup :** 30 minutes  
**Difficult√© :** ‚≠ê‚≠ê (Facile)

---

## üìã SOMMAIRE

1. [Cr√©er compte Sentry](#1-cr√©er-compte-sentry)
2. [Installation packages](#2-installation-packages)
3. [Configuration DSN](#3-configuration-dsn)
4. [Configuration Vite (Source Maps)](#4-configuration-vite)
5. [Int√©gration avec Auth](#5-int√©gration-auth)
6. [Testing](#6-testing)
7. [Monitoring Production](#7-monitoring-production)

---

## 1. Cr√©er compte Sentry

### √âtape 1.1 : Inscription
üëâ https://sentry.io/signup/

**Plan recommand√© pour d√©marrer :** FREE
- ‚úÖ 5,000 errors/mois
- ‚úÖ 10,000 performance units
- ‚úÖ 1 membre d'√©quipe
- ‚úÖ 30 jours de r√©tention

### √âtape 1.2 : Cr√©er un projet
1. Cliquer "Create Project"
2. **Platform :** React
3. **Alert frequency :** Real-time
4. **Project name :** payhuk-frontend
5. Copier le **DSN** (Data Source Name)

Exemple DSN :
```
https://abc123def456ghi789jkl012mno345@o123456.ingest.sentry.io/7891011
```

‚ö†Ô∏è **IMPORTANT :** Garder ce DSN secret !

---

## 2. Installation packages

### √âtape 2.1 : Installer SDK Sentry

```bash
# Les packages sont d√©j√† install√©s dans Payhuk !
# Si besoin de r√©installer :
npm install @sentry/react @sentry/vite-plugin
```

### √âtape 2.2 : V√©rifier package.json

```json
{
  "dependencies": {
    "@sentry/react": "^8.0.0"
  },
  "devDependencies": {
    "@sentry/vite-plugin": "^2.0.0"
  }
}
```

‚úÖ D√©j√† fait dans Payhuk !

---

## 3. Configuration DSN

### √âtape 3.1 : Ajouter variable d'environnement

**Fichier :** `.env.local` (pour d√©veloppement)

```env
# Sentry Configuration
VITE_SENTRY_DSN=https://abc123...@o123456.ingest.sentry.io/7891011
VITE_SENTRY_ORG=votre-org
VITE_SENTRY_PROJECT=payhuk-frontend
```

**Fichier :** Vercel Environment Variables (pour production)

```
VITE_SENTRY_DSN = https://abc123...@o123456.ingest.sentry.io/7891011
VITE_SENTRY_ORG = votre-org
VITE_SENTRY_PROJECT = payhuk-frontend
```

### √âtape 3.2 : Auth Token (pour source maps)

1. Aller dans Sentry ‚Üí Settings ‚Üí Account ‚Üí API ‚Üí Auth Tokens
2. Cr√©er un nouveau token :
   - **Name :** Payhuk CI/CD
   - **Scopes :**
     - `project:read`
     - `project:releases`
     - `org:read`
3. Copier le token
4. Ajouter dans `.env.local` :

```env
SENTRY_AUTH_TOKEN=sntrys_votre_token_secret_ici
```

5. Dans Vercel ‚Üí Settings ‚Üí Environment Variables :
```
SENTRY_AUTH_TOKEN = sntrys_votre_token_secret_ici
```

‚ö†Ô∏è **JAMAIS commit ce token dans Git !**

---

## 4. Configuration Vite

### √âtape 4.1 : Modifier vite.config.ts

Le fichier est d√©j√† configur√©, mais voici la config compl√®te :

```typescript
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react-swc';
import path from 'path';
import { sentryVitePlugin } from '@sentry/vite-plugin';

export default defineConfig({
  plugins: [
    react(),
    
    // Sentry plugin pour source maps (seulement en production)
    process.env.NODE_ENV === 'production' && sentryVitePlugin({
      org: process.env.VITE_SENTRY_ORG,
      project: process.env.VITE_SENTRY_PROJECT,
      authToken: process.env.SENTRY_AUTH_TOKEN,
      
      // Upload source maps
      sourcemaps: {
        assets: './dist/**',
        ignore: ['node_modules/**'],
      },
      
      // Configuration release
      release: {
        name: process.env.VERCEL_GIT_COMMIT_SHA || 'development',
        deploy: {
          env: process.env.VERCEL_ENV || 'development',
        },
      },
      
      // Options avanc√©es
      telemetry: false,
      silent: false,
    }),
  ].filter(Boolean),
  
  build: {
    // Activer source maps en production
    sourcemap: true,
    
    // Rollup options
    rollupOptions: {
      output: {
        // Optimiser le nom des chunks pour Sentry
        manualChunks: {
          'sentry': ['@sentry/react'],
        },
      },
    },
  },
  
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
    },
  },
});
```

### √âtape 4.2 : Configurer .gitignore

V√©rifier que `.env.local` et le token Sentry sont ignor√©s :

```gitignore
# Environment variables
.env.local
.env.*.local

# Sentry
.sentryclirc
sentry.properties

# Source maps (ne pas commit en production)
dist/**/*.map
```

---

## 5. Int√©gration avec Auth

### √âtape 5.1 : Tracker l'utilisateur connect√©

Le code est d√©j√† dans `src/contexts/AuthContext.tsx`, mais voici l'essentiel :

```typescript
import { setSentryUser, clearSentryUser } from '@/lib/sentry';

// Lors du login
useEffect(() => {
  if (user) {
    setSentryUser({
      id: user.id,
      email: user.email,
      username: user.user_metadata?.name || user.email?.split('@')[0],
    });
  } else {
    clearSentryUser();
  }
}, [user]);
```

‚úÖ D√©j√† impl√©ment√© dans Payhuk !

### √âtape 5.2 : Ajouter contexte m√©tier

Exemple dans un cours :

```typescript
import { addBreadcrumb } from '@/lib/sentry';

// Lors de l'enrollment
addBreadcrumb('User enrolled in course', 'course', 'info');

// Lors d'une erreur de paiement
captureError(error, {
  course_id: courseId,
  price: course.price,
  payment_method: 'moneroo',
});
```

---

## 6. Testing

### √âtape 6.1 : Test en d√©veloppement

Cr√©er une erreur volontaire :

```typescript
// Ajouter temporairement dans un composant
<button onClick={() => {
  throw new Error('Test Sentry Error!');
}}>
  Test Sentry
</button>
```

Ou via console :

```javascript
window.Sentry.captureException(new Error('Test from console'));
```

### √âtape 6.2 : V√©rifier dans Sentry

1. Aller sur https://sentry.io
2. S√©lectionner projet "payhuk-frontend"
3. **Issues** ‚Üí Voir l'erreur captur√©e
4. V√©rifier :
   - ‚úÖ Stack trace complet
   - ‚úÖ User context
   - ‚úÖ Breadcrumbs
   - ‚úÖ Device info

### √âtape 6.3 : Test performance

```typescript
import { measurePerformance } from '@/lib/sentry';

const fetchCourses = async () => {
  return measurePerformance('fetch-courses', async () => {
    const response = await fetch('/api/courses');
    return response.json();
  }, {
    category: 'api',
  });
};
```

---

## 7. Monitoring Production

### √âtape 7.1 : Alertes

Configurer les alertes dans Sentry :

1. **Settings ‚Üí Alerts ‚Üí New Alert Rule**
2. **Conditions :**
   - `When` : An event is seen
   - `If` : Issue is first seen OR more than 10 times in 1 hour
3. **Actions :**
   - Send notification to : Email (vous)
   - Send notification to : Slack (optionnel)

### √âtape 7.2 : Dashboard personnalis√©

Cr√©er un dashboard pour surveiller :

**M√©triques cl√©s :**
- Total errors (last 24h)
- Error rate (%)
- Most common errors
- Affected users
- Browser breakdown
- Performance metrics

### √âtape 7.3 : Releases

Lier les erreurs aux releases :

```bash
# Lors du d√©ploiement Vercel (automatique avec plugin)
# La version sera : VERCEL_GIT_COMMIT_SHA

# Pour voir les erreurs par version :
# Sentry ‚Üí Releases ‚Üí S√©lectionner une version
```

### √âtape 7.4 : Source Maps v√©rification

Apr√®s d√©ploiement, v√©rifier que les source maps fonctionnent :

1. Provoquer une erreur en production
2. Aller dans Sentry ‚Üí Issues
3. V√©rifier que le stack trace montre :
   - ‚úÖ Nom fichier source (pas minifi√©)
   - ‚úÖ Num√©ros de ligne corrects
   - ‚úÖ Code source visible

---

## üéØ CHECKLIST FINALE

### Setup Initial
- [ ] Compte Sentry cr√©√©
- [ ] Projet cr√©√©
- [ ] DSN copi√©
- [ ] Variables env configur√©es (local + Vercel)
- [ ] Auth token cr√©√©

### Configuration Code
- [ ] `vite.config.ts` configur√©
- [ ] Source maps activ√©s
- [ ] `.gitignore` √† jour
- [ ] Sentry initialis√© dans App
- [ ] User context int√©gr√©

### Testing
- [ ] Test erreur en dev (fonctionne)
- [ ] Test erreur en prod (stack trace correct)
- [ ] Performance tracking (fonctionne)
- [ ] Breadcrumbs (enregistr√©s)

### Production
- [ ] Alertes configur√©es
- [ ] Dashboard cr√©√©
- [ ] Team invit√©e (optionnel)
- [ ] Source maps upload√©s

---

## üìä EXEMPLES D'UTILISATION

### Exemple 1 : Capturer erreur API

```typescript
import { withSentry } from '@/lib/sentry';

export const useCourses = () => {
  return useQuery({
    queryKey: ['courses'],
    queryFn: () => withSentry('fetch-courses', async () => {
      const { data, error } = await supabase
        .from('courses')
        .select('*');
      
      if (error) throw error;
      return data;
    }, {
      user_id: user?.id,
      timestamp: Date.now(),
    }),
  });
};
```

### Exemple 2 : Mesurer performance

```typescript
import { measurePerformance } from '@/lib/sentry';

const processVideoUpload = async (file: File) => {
  return measurePerformance('video-upload', async () => {
    // Upload logic
    const url = await uploadToSupabase(file);
    return url;
  }, {
    file_size: file.size,
    file_type: file.type,
  });
};
```

### Exemple 3 : Breadcrumbs personnalis√©s

```typescript
import { addBreadcrumb } from '@/lib/sentry';

// Tracking du parcours utilisateur
const handleCheckout = () => {
  addBreadcrumb('User initiated checkout', 'payment', 'info');
  
  // ...checkout logic
  
  addBreadcrumb('Payment processed successfully', 'payment', 'info');
};
```

---

## üö® TROUBLESHOOTING

### Probl√®me : Source maps ne s'uploadent pas

**Solution :**
```bash
# V√©rifier que le token est correct
echo $SENTRY_AUTH_TOKEN

# Build en verbose pour voir les logs
npm run build -- --mode production

# V√©rifier manuellement l'upload
npx @sentry/cli releases files <VERSION> upload-sourcemaps ./dist
```

### Probl√®me : Trop d'erreurs (quota d√©pass√©)

**Solution :**
```typescript
// Dans src/lib/sentry.ts, ajuster le sampling
tracesSampleRate: 0.1, // 10% au lieu de 100%
replaysSessionSampleRate: 0.05, // 5%
```

### Probl√®me : Erreurs non captur√©es

**Solution :**
```typescript
// Ajouter error boundary manuellement
import * as Sentry from '@sentry/react';

<Sentry.ErrorBoundary fallback={<ErrorFallback />} showDialog>
  <YourComponent />
</Sentry.ErrorBoundary>
```

---

## üìû RESSOURCES

- **Documentation officielle :** https://docs.sentry.io/platforms/javascript/guides/react/
- **Vite Plugin :** https://github.com/getsentry/sentry-javascript-bundler-plugins
- **Status Sentry :** https://status.sentry.io/
- **Support :** support@sentry.io

---

## üéâ F√âLICITATIONS !

Sentry est maintenant configur√© pour Payhuk !

**Avantages imm√©diats :**
- ‚úÖ Visibilit√© compl√®te sur les erreurs production
- ‚úÖ Stack traces d√©taill√©s
- ‚úÖ Alertes temps r√©el
- ‚úÖ Performance monitoring
- ‚úÖ Session replay (d√©bug facile)

**Next step :** D√©ployer et surveiller ! üöÄ

